# 性能监控接入与使用指南

本项目基于 Next.js + Prisma 提供 Web Vitals 采集、存储与可视化（ECharts）。

### 快速开始

- 安装依赖：`pnpm i`
- 配置环境：复制 `.env-example` 为 `.env` 并补齐数据库配置
- 生成 Prisma Client：`pnpm prisma generate`
- 迁移数据库：`pnpm prisma migrate deploy`（开发可用 `pnpm prisma migrate dev`）
- 可选：初始化数据：`pnpm tsx prisma/seed.ts`
- 启动：`pnpm dev`

## 接入步骤（前端工程）

### 1) 在 `app/layout.tsx` 挂载监控组件

```jsx
import type { Metadata } from 'next'
import './globals.css'
import ClientVitals from '@/components/ClientVitals'

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app'
}

export default function RootLayout({
  children
}: Readonly<{ children: React.ReactNode }>) {
  return (
    <html lang="en" className="bg-black">
      <body>
        <ClientVitals />
        {children}
      </body>
    </html>
  )
}
```

### 2) 采集并上报 Web Vitals（已内置 `components/ClientVitals.tsx`）

如需自定义 `projectId` 或上报格式，可参考：

```tsx
'use client'
import { useEffect } from 'react'

export const reportWebVitals = async (metric: any) => {
  const projectId = 1 // TODO: 替换为你的实际项目ID
  const body = {
    projectId,
    type: metric.name.toLowerCase(),
    value: metric.value,
    userAgent: navigator.userAgent,
    url: window.location.href,
    path: window.location.pathname
  }
  fetch('/api/metrics', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
}

export default function ClientVitals() {
  useEffect(() => {
    import('web-vitals').then(({ onCLS, onINP, onLCP, onFCP, onTTFB }) => {
      onCLS(reportWebVitals)
      onINP(reportWebVitals)
      onLCP(reportWebVitals)
      onFCP(reportWebVitals)
      onTTFB(reportWebVitals)
    })
  }, [])
  return null
}
```

## 数据结构与接口

- Prisma 模型：见 `prisma/schema.prisma`；迁移在 `prisma/migrations/*`
- API 概览：
  - `POST /api/metrics`：接收上报（`projectId`, `type`, `value`, `userAgent`, `url`, `path`, `country?`）
  - `GET /api/metrics?projectId=..&type=..&country=..&path=..`：查询某指标数据
  - `GET /api/projects`：项目列表
  - `GET /api/metrics/countries?projectId=..`：国家列表
  - `GET /api/metrics/paths?projectId=..&country=..`：路径列表

## 可视化与配置

- 仪表面板：`app/page.tsx`（ECharts 渲染）
- 指标静态配置：`app/config/metrics.ts`（修改阈值、颜色、单位、图表类型等）
- 当前图表类型：
  - 折线图 `line`：LCP、INP、FCP、TTFB
  - 柱状图 `bar`：CLS

## UI 说明（下拉选择器）

- 原生 `select` 在 blur/transform 等场景可能出现定位偏移。
- 已提供自定义下拉 `components/SimpleSelect.tsx`，并用于“国家/页面选择器”。
- 如需统一风格，可将“项目选择器”也替换为 `SimpleSelect`。

## 常见问题

- 环境变量：复制 `.env-example` 为 `.env` 并补齐配置。
- 首次启动无数据：访问接入页面产生数据或执行 `prisma/seed.ts`。
- 无国家/页面维度：接口会回落到 `global` 或返回空数组；页面选择器会禁用并显示“暂无页面”。
- 图表异常：确认安装 `echarts`、`echarts-for-react` 且控制台无报错。
